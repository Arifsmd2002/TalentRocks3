<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${project.title + ' | Talentrock'}">Project | Talentrock</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
</head>

<body>
    <div class="app-layout">
        <div th:replace="~{fragments/client-sidebar :: client-sidebar}"></div>

        <main class="main-content">
            <!-- Header -->
            <div class="page-header flex-between flex-wrap gap-2">
                <div>
                    <a href="/client/dashboard" class="text-muted text-sm"
                        style="display:inline-flex;align-items:center;gap:4px;margin-bottom:8px;">‚Üê Back to
                        Dashboard</a>
                    <h1 class="page-title" th:text="${project.title}">Project Title</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span th:switch="${project.status.name()}">
                            <span th:case="'OPEN'" class="project-badge badge-open">üü¢ Open</span>
                            <span th:case="'IN_PROGRESS'" class="project-badge badge-progress">üîµ In Progress</span>
                            <span th:case="'COMPLETED'" class="project-badge badge-completed">‚úÖ Completed</span>
                            <span th:case="*" class="project-badge badge-pending"
                                th:text="${project.status}">Status</span>
                        </span>
                        <span class="text-muted text-sm" th:text="${project.category}">Category</span>
                    </div>
                </div>
                <div th:if="${project.status.name() == 'IN_PROGRESS'}">
                    <a th:href="@{/client/project/{id}/add-milestone(id=${project.id})}" class="btn btn-secondary">+ Add
                        Milestone</a>
                </div>
            </div>

            <div th:if="${success}" class="alert alert-success">‚úÖ <span th:text="${success}"></span></div>
            <div th:if="${error}" class="alert alert-error">‚ö†Ô∏è <span th:text="${error}"></span></div>

            <div class="grid grid-2 mb-4" style="grid-template-columns:2fr 1fr; gap:1.5rem;">
                <!-- Project Details -->
                <div>
                    <div class="card mb-3">
                        <div class="card-header">üìÑ Project Details</div>
                        <div class="card-body">
                            <p style="color:var(--text-secondary); line-height:1.8;" th:text="${project.description}">
                                Description</p>
                            <div class="divider"></div>
                            <div class="grid grid-2" style="gap:1rem;">
                                <div>
                                    <div class="text-muted text-xs mb-1">BUDGET RANGE</div>
                                    <div class="font-bold">‚Çπ<span
                                            th:text="${#numbers.formatDecimal(project.budgetMin, 1, 0)}">0</span> ‚Äì
                                        ‚Çπ<span th:text="${#numbers.formatDecimal(project.budgetMax, 1, 0)}">0</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-muted text-xs mb-1">DEADLINE</div>
                                    <div class="font-bold"
                                        th:text="${project.deadline != null ? #temporals.format(project.deadline, 'dd MMM yyyy') : 'Flexible'}">
                                        Flexible</div>
                                </div>
                                <div th:if="${project.skillsRequired}">
                                    <div class="text-muted text-xs mb-1">REQUIRED SKILLS</div>
                                    <div style="font-size:0.9rem;" th:text="${project.skillsRequired}">Skills</div>
                                </div>
                                <div th:if="${project.assignedFreelancer != null}">
                                    <div class="text-muted text-xs mb-1">ASSIGNED TO</div>
                                    <div class="flex items-center gap-2">
                                        <div class="avatar" style="width:28px;height:28px;font-size:0.78rem;"
                                            th:text="${project.assignedFreelancer.fullName != null ? project.assignedFreelancer.fullName.substring(0,1) : 'F'}">
                                            F</div>
                                        <span style="font-size:0.9rem; font-weight:600;"
                                            th:text="${project.assignedFreelancer.fullName}">Freelancer</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Milestones -->
                    <div class="card" th:if="${milestones != null and !milestones.isEmpty()}">
                        <div class="card-header">üéØ Milestone Tracker</div>
                        <div class="card-body">
                            <div th:each="milestone : ${milestones}"
                                style="border:1px solid var(--bg-border); border-radius:12px; padding:1.25rem; margin-bottom:1rem; transition:var(--transition);">
                                <div class="flex-between mb-2">
                                    <div>
                                        <div style="font-weight:600;" th:text="${milestone.title}">Milestone</div>
                                        <div class="text-muted text-xs"
                                            th:text="${milestone.dueDate != null ? 'Due: ' + #temporals.format(milestone.dueDate, 'dd MMM yyyy') : ''}">
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span th:if="${milestone.amount != null}"
                                            style="font-weight:700; color:var(--secondary);">‚Çπ<span
                                                th:text="${#numbers.formatDecimal(milestone.amount, 1, 0)}">0</span></span>
                                        <span th:switch="${milestone.status.name()}">
                                            <span th:case="'PENDING'" class="project-badge badge-pending">‚è≥
                                                Pending</span>
                                            <span th:case="'IN_PROGRESS'" class="project-badge badge-progress">üîµ
                                                Working</span>
                                            <span th:case="'SUBMITTED'" class="project-badge"
                                                style="background:rgba(252,211,77,0.15);color:var(--warning);">üì®
                                                Review</span>
                                            <span th:case="'APPROVED'" class="project-badge badge-completed">‚úÖ
                                                Approved</span>
                                            <span th:case="'REJECTED'" class="project-badge badge-cancelled">‚ùå
                                                Rejected</span>
                                        </span>
                                    </div>
                                </div>
                                <p class="text-secondary-color text-sm" th:text="${milestone.description}"></p>
                                <!-- Approve/Reject actions for SUBMITTED milestones -->
                                <div th:if="${milestone.status.name() == 'SUBMITTED'}" class="flex gap-2 mt-2">
                                    <form th:action="@{/client/milestone/{id}/approve(id=${milestone.id})}"
                                        method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-success btn-sm">‚úÖ Approve & Pay</button>
                                    </form>
                                    <button onclick="showRejectForm(this)" class="btn btn-danger btn-sm">‚ùå
                                        Reject</button>
                                    <form th:action="@{/client/milestone/{id}/reject(id=${milestone.id})}" method="post"
                                        style="display:none;" class="reject-form">
                                        <input type="text" name="feedback" placeholder="Reason for rejection..."
                                            class="form-control" style="display:inline-block;width:auto;" required />
                                        <button type="submit" class="btn btn-danger btn-sm">Submit</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bids Panel -->
                <div>
                    <div class="card">
                        <div class="card-header">üíº Bids Received (<span
                                th:text="${bids != null ? bids.size() : 0}">0</span>)</div>
                        <div class="card-body">
                            <div th:if="${bids == null or bids.isEmpty()}"
                                style="text-align:center; padding:2rem 0; color:var(--text-muted);">
                                <div style="font-size:2.5rem; margin-bottom:0.5rem;">üîî</div>
                                <p class="text-sm">No bids yet. Your project is live!</p>
                            </div>
                            <div th:each="bid : ${bids}"
                                style="border:1px solid var(--bg-border); border-radius:12px; padding:1.25rem; margin-bottom:1rem; transition:var(--transition);"
                                class="card">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="avatar" style="width:36px;height:36px;font-size:0.9rem;"
                                        th:text="${bid.freelancer.fullName != null ? bid.freelancer.fullName.substring(0,1).toUpperCase() : 'F'}">
                                        F</div>
                                    <div>
                                        <div style="font-weight:600; font-size:0.9rem;"
                                            th:text="${bid.freelancer.fullName != null ? bid.freelancer.fullName : bid.freelancer.username}">
                                            Freelancer</div>
                                        <div class="text-muted text-xs"
                                            th:text="${'Score: ' + bid.freelancer.performanceScore + '/10'}">Score</div>
                                    </div>
                                    <span th:switch="${bid.status.name()}" style="margin-left:auto;">
                                        <span th:case="'PENDING'" class="project-badge badge-pending">Pending</span>
                                        <span th:case="'ACCEPTED'" class="project-badge badge-accepted">‚úÖ
                                            Accepted</span>
                                        <span th:case="'REJECTED'" class="project-badge badge-cancelled">Rejected</span>
                                    </span>
                                </div>
                                <div class="flex-between mb-2">
                                    <span style="font-weight:700; color:var(--secondary); font-size:1.1rem;">‚Çπ<span
                                            th:text="${#numbers.formatDecimal(bid.bidAmount, 1, 0)}">0</span></span>
                                    <span class="text-muted text-xs"
                                        th:text="${bid.deliveryDays + ' days delivery'}">Days</span>
                                </div>
                                <p class="text-secondary-color text-sm" th:text="${bid.proposal}"
                                    style="margin-bottom:0.75rem; line-height:1.6;"></p>
                                <div th:if="${bid.demoWorkUrl}" class="mb-2">
                                    <a th:href="${bid.demoWorkUrl}" target="_blank"
                                        class="text-primary-color text-sm">üîó View Demo Work</a>
                                </div>
                                <div th:if="${project.status.name() == 'OPEN' and bid.status.name() == 'PENDING'}">
                                    <form
                                        th:action="@{/client/project/{pid}/accept-bid/{bid}(pid=${project.id},bid=${bid.id})}"
                                        method="post">
                                        <button type="submit" class="btn btn-primary btn-sm" style="width:100%;">Accept
                                            This Bid ‚úì</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function showRejectForm(btn) {
            btn.style.display = 'none';
            btn.nextElementSibling.style.display = 'inline-flex';
        }
    </script>
</body>

</html>
