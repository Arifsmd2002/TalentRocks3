<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Freelancer Dashboard | Talentrock</title>
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
</head>

<body>
    <div class="app-layout">
        <div th:replace="~{fragments/freelancer-sidebar :: freelancer-sidebar}"></div>

        <main class="main-content">
            <div class="page-header flex-between">
                <div>
                    <h1 class="page-title">Hi, <span class="gradient-text"
                            th:text="${user.fullName != null ? user.fullName : user.username}">Freelancer</span> üëã</h1>
                    <p class="page-subtitle">Ready to find your next great project?</p>
                </div>
                <a href="/freelancer/browse" class="btn btn-primary">üîç Browse Projects</a>
            </div>

            <div th:if="${success}" class="alert alert-success">‚úÖ <span th:text="${success}"></span></div>
            <div th:if="${error}" class="alert alert-error">‚ö†Ô∏è <span th:text="${error}"></span></div>

            <!-- Stats -->
            <div class="grid grid-4 mb-4">
                <div class="stat-card">
                    <div class="stat-icon purple">üì©</div>
                    <div>
                        <div class="stat-value" th:text="${myBids != null ? myBids.size() : 0}">0</div>
                        <div class="stat-label">Total Bids</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon gold">‚è≥</div>
                    <div>
                        <div class="stat-value" th:text="${pendingBids}">0</div>
                        <div class="stat-label">Pending Bids</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon green">‚úÖ</div>
                    <div>
                        <div class="stat-value" th:text="${acceptedBids}">0</div>
                        <div class="stat-label">Accepted Bids</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon teal">üí∞</div>
                    <div>
                        <div class="stat-value">‚Çπ<span
                                th:text="${#numbers.formatDecimal(user.walletBalance, 1, 0)}">0</span></div>
                        <div class="stat-label">Wallet Balance</div>
                    </div>
                </div>
            </div>

            <!-- Performance + Active Projects -->
            <div class="grid grid-2 mb-4">
                <!-- Performance Card -->
                <div class="card">
                    <div class="card-header">‚≠ê Performance Score</div>
                    <div class="card-body">
                        <div class="flex items-center gap-4">
                            <div style="position:relative; flex-shrink:0;">
                                <svg width="100" height="100" viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="40" fill="none" stroke="var(--bg-surface)"
                                        stroke-width="10" />
                                    <circle cx="50" cy="50" r="40" fill="none" stroke="var(--primary)" stroke-width="10"
                                        stroke-dasharray="251.2"
                                        th:stroke-dashoffset="${251.2 - (251.2 * (user.performanceScore != null ? user.performanceScore : 5.0) / 10)}"
                                        stroke-linecap="round" transform="rotate(-90 50 50)"
                                        style="transition:stroke-dashoffset 1s ease;" />
                                </svg>
                                <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:1.2rem;"
                                    th:text="${user.performanceScore != null ? user.performanceScore : '5.0'}">5.0</div>
                            </div>
                            <div>
                                <h3 style="font-size:1.5rem; margin-bottom:0.5rem;"
                                    th:text="${user.performanceScore != null ? user.performanceScore + ' / 10' : '5.0 / 10'}">
                                    5.0 / 10</h3>
                                <p class="text-secondary-color text-sm">Based on delivery rate, completion rate, and
                                    client ratings</p>
                                <div class="mt-2">
                                    <div class="flex-between mb-1">
                                        <span class="text-xs text-muted">Completed Projects</span>
                                        <span class="text-xs font-bold"
                                            th:text="${user.completedProjects != null ? user.completedProjects : 0}">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Projects -->
                <div class="card">
                    <div class="card-header">‚öôÔ∏è Active Projects</div>
                    <div class="card-body">
                        <div th:if="${activeProjects == null or activeProjects.isEmpty()}"
                            style="text-align:center; padding:1.5rem; color:var(--text-muted);">
                            <div style="font-size:2rem; margin-bottom:0.5rem;">üöÄ</div>
                            <p class="text-sm">No active projects. Start bidding!</p>
                            <a href="/freelancer/browse" class="btn btn-primary btn-sm mt-2">Find Projects</a>
                        </div>
                        <div th:each="project : ${activeProjects}">
                            <div
                                style="border:1px solid var(--bg-border); border-radius:10px; padding:1rem; margin-bottom:0.75rem;">
                                <div class="flex-between mb-1">
                                    <span style="font-weight:600; font-size:0.9rem;"
                                        th:text="${project.title}">Project</span>
                                    <span class="project-badge badge-progress">In Progress</span>
                                </div>
                                <a th:href="@{/freelancer/active-project/{id}(id=${project.id})}"
                                    class="btn btn-ghost btn-sm" style="width:100%; margin-top:0.5rem;">View Milestones
                                    ‚Üí</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Bids Table -->
            <div class="card">
                <div class="card-header flex-between">
                    <span>üì© My Bids</span>
                    <a href="/freelancer/browse" class="btn btn-ghost btn-sm">Find More Projects</a>
                </div>
                <div th:if="${myBids == null or myBids.isEmpty()}"
                    style="padding:3rem; text-align:center; color:var(--text-muted);">
                    <div style="font-size:3rem; margin-bottom:1rem;">üîç</div>
                    <p>No bids submitted yet. Browse open projects!</p>
                    <a href="/freelancer/browse" class="btn btn-primary mt-2">Browse Projects</a>
                </div>
                <div th:if="${myBids != null and !myBids.isEmpty()}" class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Bid Amount</th>
                                <th>Delivery</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="bid : ${myBids}">
                                <td>
                                    <div style="font-weight:600;" th:text="${bid.project.title}">Project</div>
                                    <div class="text-muted text-xs" th:text="${bid.project.category}">Category</div>
                                </td>
                                <td style="font-weight:700; color:var(--secondary);">‚Çπ<span
                                        th:text="${#numbers.formatDecimal(bid.bidAmount, 1, 0)}">0</span></td>
                                <td class="text-secondary-color" th:text="${bid.deliveryDays + ' days'}">Days</td>
                                <td>
                                    <span th:switch="${bid.status.name()}">
                                        <span th:case="'PENDING'" class="project-badge badge-pending">‚è≥ Pending</span>
                                        <span th:case="'ACCEPTED'" class="project-badge badge-accepted">‚úÖ
                                            Accepted</span>
                                        <span th:case="'REJECTED'" class="project-badge badge-cancelled">‚ùå
                                            Rejected</span>
                                        <span th:case="'WITHDRAWN'" class="project-badge badge-pending">‚Ü©Ô∏è
                                            Withdrawn</span>
                                    </span>
                                </td>
                                <td class="text-muted text-sm"
                                    th:text="${bid.createdAt != null ? #temporals.format(bid.createdAt, 'dd MMM') : '-'}">
                                    Date</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- ============================================================
         NOTIFICATION BELL (Freelancer)
         ============================================================ -->
    <div id="notif-bell-wrap" style="position:fixed;top:1rem;right:1.5rem;z-index:8888;">
        <button id="notif-bell-btn" onclick="toggleNotifDropdown()"
            style="position:relative;width:44px;height:44px;border-radius:50%;background:rgba(15,22,40,0.9);border:1px solid rgba(255,255,255,0.1);color:rgba(255,255,255,0.8);font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);transition:all 0.2s;box-shadow:0 4px 20px rgba(0,0,0,0.3);"
            title="Notifications">
            üîî
            <span id="notif-badge"
                style="display:none;position:absolute;top:-4px;right:-4px;background:#ef4444;color:#fff;border-radius:999px;font-size:0.65rem;font-weight:800;padding:0.1rem 0.38rem;min-width:17px;text-align:center;line-height:1.4;border:2px solid #050b18;"></span>
        </button>

        <!-- Dropdown panel -->
        <div id="notif-dropdown"
            style="display:none;position:absolute;right:0;top:54px;width:340px;max-height:480px;overflow-y:auto;background:#0d1425;border:1px solid rgba(255,255,255,0.1);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.5);backdrop-filter:blur(12px);">
            <div
                style="display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;border-bottom:1px solid rgba(255,255,255,0.07);">
                <span style="font-weight:700;font-size:0.95rem;color:#fff;">üîî Notifications</span>
                <button onclick="markAllRead()"
                    style="background:none;border:none;color:#818cf8;font-size:0.78rem;font-weight:600;cursor:pointer;padding:0;">Mark
                    all read</button>
            </div>
            <div id="notif-list" style="padding:0.5rem 0;"></div>
        </div>
    </div>

    <script>
        (function () {
            let isOpen = false;

            // Close on outside click
            document.addEventListener('click', function (e) {
                if (isOpen && !document.getElementById('notif-bell-wrap').contains(e.target)) {
                    document.getElementById('notif-dropdown').style.display = 'none';
                    isOpen = false;
                }
            });

            function fetchCount() {
                fetch('/notifications/count', { credentials: 'same-origin' })
                    .then(r => r.json())
                    .then(data => {
                        const badge = document.getElementById('notif-badge');
                        if (data.count > 0) {
                            badge.textContent = data.count > 99 ? '99+' : data.count;
                            badge.style.display = 'block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }).catch(() => { });
            }

            window.toggleNotifDropdown = function () {
                isOpen = !isOpen;
                const dd = document.getElementById('notif-dropdown');
                dd.style.display = isOpen ? 'block' : 'none';
                if (isOpen) loadNotifications();
            };

            window.loadNotifications = function () {
                fetch('/notifications/list', { credentials: 'same-origin' })
                    .then(r => r.json())
                    .then(items => {
                        const list = document.getElementById('notif-list');
                        if (!items.length) {
                            list.innerHTML = '<div style="padding:2rem;text-align:center;color:rgba(255,255,255,0.35);font-size:0.88rem;">No notifications yet üéâ</div>';
                            return;
                        }
                        list.innerHTML = items.map(n => `
                        <a href="${n.link}" onclick="markRead(${n.id})"
                           style="display:block;padding:0.85rem 1.25rem;text-decoration:none;border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.15s;${!n.isRead ? 'border-left:3px solid #6366f1;' : 'border-left:3px solid transparent;'}">
                            <div style="font-size:0.88rem;font-weight:${n.isRead ? '500' : '700'};color:${n.isRead ? 'rgba(255,255,255,0.55)' : '#fff'};margin-bottom:0.2rem;">${n.title}</div>
                            <div style="font-size:0.78rem;color:rgba(255,255,255,0.4);margin-bottom:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${n.message}</div>
                            <div style="font-size:0.7rem;color:rgba(255,255,255,0.25);">${n.time}</div>
                        </a>
                    `).join('');
                    }).catch(() => { });
            };

            window.markRead = function (id) {
                fetch('/notifications/' + id + '/read', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                }).then(() => fetchCount()).catch(() => { });
            };

            window.markAllRead = function () {
                fetch('/notifications/mark-all-read', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                }).then(() => {
                    fetchCount();
                    loadNotifications();
                }).catch(() => { });
            };

            // Initial fetch + poll every 30s
            fetchCount();
            setInterval(fetchCount, 30000);
        })();
    </script>
</body>

</html>